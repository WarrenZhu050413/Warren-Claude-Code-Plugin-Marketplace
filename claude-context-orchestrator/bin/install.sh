#!/bin/bash
#
# Installation script for snippets CLI
#
# This script installs the snippets CLI globally by creating a symlink
# in a directory that's in your PATH.
#
# Usage:
#   ./install.sh           # Install to /usr/local/bin (requires sudo)
#   ./install.sh ~/bin     # Install to custom directory
#

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Get the directory where this script is located
SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"
CLI_SCRIPT="${SCRIPT_DIR}/snippets_cli.py"

# Default installation directory
INSTALL_DIR="${1:-/usr/local/bin}"

# Check if CLI script exists
if [ ! -f "$CLI_SCRIPT" ]; then
    echo -e "${RED}Error: snippets_cli.py not found at ${CLI_SCRIPT}${NC}"
    exit 1
fi

# Create installation directory if it doesn't exist
if [ ! -d "$INSTALL_DIR" ]; then
    echo -e "${BLUE}Creating directory: ${INSTALL_DIR}${NC}"
    mkdir -p "$INSTALL_DIR"
fi

# Check if we need sudo
SUDO=""
if [ ! -w "$INSTALL_DIR" ]; then
    SUDO="sudo"
    echo -e "${BLUE}Installation requires sudo for ${INSTALL_DIR}${NC}"
fi

# Create wrapper script
WRAPPER_SCRIPT="${INSTALL_DIR}/snippets"

echo -e "${BLUE}Installing snippets CLI to ${INSTALL_DIR}/snippets${NC}"

# Create the wrapper script
$SUDO tee "$WRAPPER_SCRIPT" > /dev/null << EOF
#!/bin/bash
#
# Snippets CLI wrapper
# Auto-generated by install.sh
#

exec python3 "${CLI_SCRIPT}" "\$@"
EOF

# Make it executable
$SUDO chmod +x "$WRAPPER_SCRIPT"

echo -e "${GREEN}âœ“ Installation successful!${NC}"
echo ""
echo -e "${BLUE}The 'snippets' command is now available.${NC}"
echo ""
echo "Try it out:"
echo -e "  ${GREEN}snippets list${NC}"
echo -e "  ${GREEN}snippets validate${NC}"
echo -e "  ${GREEN}snippets --help${NC}"
echo ""

# Check if directory is in PATH
if ! echo "$PATH" | grep -q "$INSTALL_DIR"; then
    echo -e "${RED}Warning: ${INSTALL_DIR} is not in your PATH${NC}"
    echo ""
    echo "Add this line to your ~/.bashrc or ~/.zshrc:"
    echo -e "  ${BLUE}export PATH=\"${INSTALL_DIR}:\$PATH\"${NC}"
    echo ""
fi

echo "Done!"
